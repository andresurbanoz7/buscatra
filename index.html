<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta por Código</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header img {
      max-width: 120px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1rem;
      border-radius: 5px;
    }
    input {
      border: 1px solid #ccc;
    }
    button {
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .acciones {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    @media (min-width: 480px) {
      .acciones {
        flex-direction: row;
      }
    }
    .resultado {
      margin-top: 20px;
      padding: 15px;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #cargando {
      text-align: center;
      color: #555;
      font-size: 0.95em;
      margin-bottom: 10px;
    }
    footer {
      text-align: center;
      font-size: 0.9em;
      margin-top: 40px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://raw.githubusercontent.com/andresurbanoz7/buscatra/refs/heads/main/logo-sindicato.jpg" alt="Logo Sindicato">
      <h2>Consulta tu resultado de la negociación</h2>
    </header>

    <div id="cargando">Cargando archivo...</div>

    <label for="codigo">Ingresa tu código (4 dígitos):</label>
    <input type="number" id="codigo" placeholder="Ej: 1234">
    <button onclick="buscarPorCodigo()">Consultar</button>

    <div id="resultado" class="resultado" style="display:none;"></div>
    <div class="acciones" id="acciones" style="display:none;">
      <button onclick="window.print()">Imprimir</button>
      <button onclick="compartirResultado()">Compartir</button>
    </div>

    <footer>
      Sindicato Logística Nacional Santa Isabel &mdash; Todos los derechos reservados
    </footer>
  </div>

  <script>
    const trabajadores = [];
    let datosCargados = false;

    fetch('https://raw.githubusercontent.com/andresurbanoz7/buscatra/main/trabajadores_locales_completo.json')
      .then(res => res.json())
      .then(data => {
        trabajadores.push(...data);
        datosCargados = true;
        document.getElementById('cargando').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('cargando').textContent = 'Error al cargar los datos';
      });

    function buscarPorCodigo() {
      if (!datosCargados) {
        alert("Los datos aún se están cargando. Por favor, espera unos segundos e intenta de nuevo.");
        return;
      }

      const codigo = document.getElementById('codigo').value.trim();
      const resultado = document.getElementById('resultado');
      const acciones = document.getElementById('acciones');
      const persona = trabajadores.find(t => String(t.codigo) === codigo);

      if (persona) {
        const aguinaldoTexto = persona.antiguedad >= 10 && persona.jornada === 45
          ? `25% o 30% del sueldo base según corresponda`
          : `$${persona.aguinaldo.toLocaleString('es-CL')}`;

        resultado.style.display = 'block';
        acciones.style.display = 'flex';
        resultado.innerHTML = `
          <strong>${persona.nombre}</strong><br>
          Jornada: ${persona.jornada} horas<br>
          Antigüedad: ${persona.antiguedad.toFixed(2)} años<br><br>
          <strong>Nuevo Sueldo Base:</strong> $${persona.sueldo_base.toLocaleString('es-CL')}<br>
          <strong>Movilización:</strong> $${persona.movilizacion.toLocaleString('es-CL')}<br>
          <strong>Presentismo:</strong> $${persona.presentismo.toLocaleString('es-CL')}<br>
          <strong>Asignación de Caja:</strong> $${persona.asig_caja.toLocaleString('es-CL')}<br>
          <strong>Aguinaldo:</strong> ${aguinaldoTexto}<br>
          <strong>Vacaciones Día Verano:</strong> $${persona.vacaciones_verano.toLocaleString('es-CL')}<br>
          <strong>Vacaciones Día Invierno:</strong> $${persona.vacaciones_invierno.toLocaleString('es-CL')}<br>
          <strong style="color:#007bff">Bono Término de Negociación:</strong> $${calcularBono(persona.antiguedad, persona.jornada).toLocaleString('es-CL')}<br>
        `;
      } else {
        resultado.style.display = 'block';
        acciones.style.display = 'none';
        resultado.innerHTML = '<span style="color:red">Código no encontrado.</span>';
      }
    }

    function compartirResultado() {
      const url = window.location.href;
      navigator.clipboard.writeText(url);
      alert("Enlace copiado al portapapeles para compartir");
    }

    function calcularBono(antiguedadAnios, jornada) {
      const factorFijo = 33;
      const antiguedadRedondeada = Math.round(antiguedadAnios * 100) / 100;
      const meses = antiguedadRedondeada * 12;

      if (jornada === 45) {
        if (antiguedadAnios > 25) return 1400000;
        const tabla45 = [
          { min: 0, max: 12, valor: 1000, fijo: 2000 },
          { min: 13, max: 23, valor: 1450, fijo: 2400 },
          { min: 24, max: 35, valor: 1600, fijo: 2500 },
          { min: 36, max: 54, valor: 2000, fijo: 2500 },
          { min: 55, max: 117, valor: 2500, fijo: 3100 },
          { min: 118, max: 500, valor: 3000, fijo: 3100 }
        ];
        const rango = tabla45.find(r => meses >= r.min && meses <= r.max);
        return rango ? Math.round(rango.valor * antiguedadRedondeada * 12 + rango.fijo * factorFijo) : 0;
      }

      if (jornada === 30 || jornada === 20) {
        const tablaParcial = [
          { min: 0, max: 12, valor: 950, fijo: 1200 },
          { min: 13, max: 22, valor: 1250, fijo: 1400 },
          { min: 23, max: 35, valor: 1350, fijo: 1500 },
          { min: 36, max: 54, valor: 1550, fijo: 1800 },
          { min: 55, max: 107, valor: 1650, fijo: 1900 },
          { min: 108, max: 368, valor: 1750, fijo: 2000 }
        ];
        const rango = tablaParcial.find(r => meses >= r.min && meses <= r.max);
        return rango ? Math.round(rango.valor * antiguedadRedondeada * 12 + rango.fijo * factorFijo) : 0;
      }

      return 0;
    }
  </script>
</body>
</html>
